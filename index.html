<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta charset="utf-8" />
        <title>frac-js</title>

        <link href="//cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.1/leaflet.css" rel="stylesheet" />
        <script src="//cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.1/leaflet.js"></script>

        <style>

        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
        }

        </style>

    </head>
    <body onload="go()">
        <div id="map"></div>

        <script>

var tileSize = 256
var worker = new Worker('worker.js');
var canvases = {};
worker.onmessage = function(event){
    var c = canvases[event.data.id]
    if (!c){ return;}

    c.ctx.putImageData(event.data.imageData, 0, 0);
    c.tile.src = c.canvas.toDataURL();
    delete canvases[event.data.id];
}
var id = 0;

function go(){
  var maxDepth = 48; // precision is lost at any greater level
  var map = L.map('map', {crs: L.CRS.Simple}).setView([-128, 128], Math.min(2, maxDepth));

  

    L.TileLayer.Mandlebrot = L.TileLayer.extend({
        getAttribution: function() {
            return "<a href='https://github.com/richorama/frac-js'>frac-js</a>"
        },
        createTile:function(coords, done){
            var tile = document.createElement('img');

            L.DomEvent.on(tile, 'load', L.Util.bind(this._tileOnLoad, this, done, tile));
            L.DomEvent.on(tile, 'error', L.Util.bind(this._tileOnError, this, done, tile));

            if (this.options.crossOrigin) {
                tile.crossOrigin = '';
            }

            tile.alt = '';
            tile.id = (id++).toString();
            tile.setAttribute('role', 'presentation');

            var canvas = document.createElement("canvas");
            canvas.width = tileSize;
            canvas.height = tileSize;
            var ctx = canvas.getContext("2d");
            var imageData = ctx.getImageData(0, 0, tileSize, tileSize);

            canvases[tile.id] = {
                canvas:canvas,
                ctx:ctx,
                tile:tile
            };

            worker.postMessage({coords:coords, id:tile.id, imageData:imageData});

            return tile;
        }
    });

    L.tileLayer.mandlebrot = function() {
        return new L.TileLayer.Mandlebrot();
    }

    L.tileLayer.mandlebrot().addTo(map);
}

        </script>

    </body>
</html>
